import pygame
import os
import threading
import time

class AudioManager:
    """Sistema de gerenciamento de √°udio para o projeto"""
    
    def __init__(self):
        """Inicializa o sistema de √°udio"""
        self.initialized = False
        self.current_music = None
        self.music_volume = 0.7  # Volume da m√∫sica (0.0 - 1.0)
        self.sfx_volume = 0.8    # Volume dos efeitos sonoros
        self.master_volume = 1.0 # Volume geral
        
        # üéµ CANAIS DE SOM
        self.music_channel = None
        self.sfx_channels = []
        
        # üìÇ CACHE DE SONS CARREGADOS
        self.loaded_sounds = {}
        self.loaded_music = {}
        
        # üé¨ CONTROLE DE REPRODU√á√ÉO
        self.is_music_playing = False
        self.current_music_file = None
        self.music_position = 0.0
        
        # üîÑ SISTEMA DE FADE
        self.fade_thread = None
        self.fade_active = False
        
        self._initialize_pygame_audio()

    def _initialize_pygame_audio(self):
        """Inicializa o sistema de √°udio do pygame"""
        try:
            # üéµ INICIALIZA PYGAME MIXER
            pygame.mixer.pre_init(
                frequency=44100,    # Taxa de amostragem
                size=-16,           # 16-bit signed
                channels=2,         # Est√©reo
                buffer=512          # Buffer pequeno para baixa lat√™ncia
            )
            pygame.mixer.init()
            
            # üéµ CONFIGURA CANAIS
            pygame.mixer.set_num_channels(8)  # 8 canais para efeitos
            
            self.initialized = True
            print("üéµ AudioManager inicializado com sucesso")
            print(f"   üìä Frequency: {pygame.mixer.get_init()[0]} Hz")
            print(f"   üìä Channels: {pygame.mixer.get_init()[2]}")
            print(f"   üìä Buffer: {pygame.mixer.get_init()[1]} bytes")
            
        except Exception as e:
            print(f"‚ùå Erro ao inicializar √°udio: {e}")
            self.initialized = False

    def load_music(self, file_path, name=None):
        """Carrega m√∫sica de fundo"""
        if not self.initialized:
            print("‚ùå Sistema de √°udio n√£o inicializado")
            return False
        
        try:
            # üìÇ VERIFICA SE ARQUIVO EXISTE
            full_path = self._get_audio_path(file_path)
            if not os.path.exists(full_path):
                print(f"‚ùå Arquivo n√£o encontrado: {full_path}")
                return False
            
            # üéµ CARREGA M√öSICA
            pygame.mixer.music.load(full_path)
            
            music_name = name or os.path.basename(file_path)
            self.loaded_music[music_name] = {
                "file_path": full_path,
                "name": music_name
            }
            
            print(f"üéµ M√∫sica carregada: {music_name}")
            return True
            
        except Exception as e:
            print(f"‚ùå Erro ao carregar m√∫sica {file_path}: {e}")
            return False

    def play_music(self, file_path_or_name, loop=True, fade_in_time=0.0):
        """Reproduz m√∫sica de fundo"""
        if not self.initialized:
            print("‚ùå Sistema de √°udio n√£o inicializado")
            return False
        
        try:
            # üîç ENCONTRA M√öSICA
            music_info = None
            
            # Tenta por nome primeiro
            if file_path_or_name in self.loaded_music:
                music_info = self.loaded_music[file_path_or_name]
            else:
                # Tenta carregar arquivo diretamente
                if self.load_music(file_path_or_name):
                    music_name = os.path.basename(file_path_or_name)
                    music_info = self.loaded_music[music_name]
            
            if not music_info:
                print(f"‚ùå M√∫sica n√£o encontrada: {file_path_or_name}")
                return False
            
            # üéµ PARA M√öSICA ATUAL SE ESTIVER TOCANDO
            if self.is_music_playing:
                pygame.mixer.music.stop()
            
            # üéµ CONFIGURA VOLUME
            pygame.mixer.music.set_volume(self.music_volume * self.master_volume)
            
            # üéµ REPRODUZ M√öSICA
            loops = -1 if loop else 0  # -1 = loop infinito
            
            if fade_in_time > 0:
                pygame.mixer.music.play(loops, fade_ms=int(fade_in_time * 1000))
                print(f"üéµ M√∫sica iniciada com fade-in: {music_info['name']} ({fade_in_time}s)")
            else:
                pygame.mixer.music.play(loops)
                print(f"üéµ M√∫sica iniciada: {music_info['name']}")
            
            self.is_music_playing = True
            self.current_music_file = music_info['name']
            
            return True
            
        except Exception as e:
            print(f"‚ùå Erro ao reproduzir m√∫sica: {e}")
            return False

    def load_sound(self, file_path, name=None):
        """Carrega efeito sonoro"""
        if not self.initialized:
            print("‚ùå Sistema de √°udio n√£o inicializado")
            return False
        
        try:
            # üìÇ VERIFICA SE ARQUIVO EXISTE
            full_path = self._get_audio_path(file_path)
            if not os.path.exists(full_path):
                print(f"‚ùå Arquivo n√£o encontrado: {full_path}")
                return False
            
            # üîä CARREGA SOM
            sound = pygame.mixer.Sound(full_path)
            
            sound_name = name or os.path.basename(file_path)
            self.loaded_sounds[sound_name] = {
                "sound": sound,
                "file_path": full_path,
                "name": sound_name
            }
            
            print(f"üîä Som carregado: {sound_name}")
            return True
            
        except Exception as e:
            print(f"‚ùå Erro ao carregar som {file_path}: {e}")
            return False

    def play_sound(self, file_path_or_name, volume=1.0, loop=False):
        """Reproduz efeito sonoro"""
        if not self.initialized:
            print("‚ùå Sistema de √°udio n√£o inicializado")
            return False
        
        try:
            # üîç ENCONTRA SOM
            sound_info = None
            
            # Tenta por nome primeiro
            if file_path_or_name in self.loaded_sounds:
                sound_info = self.loaded_sounds[file_path_or_name]
            else:
                # Tenta carregar arquivo diretamente
                if self.load_sound(file_path_or_name):
                    sound_name = os.path.basename(file_path_or_name)
                    sound_info = self.loaded_sounds[sound_name]
            
            if not sound_info:
                print(f"‚ùå Som n√£o encontrado: {file_path_or_name}")
                return False
            
            # üîä CONFIGURA VOLUME
            sound = sound_info["sound"]
            sound.set_volume(volume * self.sfx_volume * self.master_volume)
            
            # üîä REPRODUZ SOM
            loops = -1 if loop else 0
            channel = sound.play(loops)
            
            if channel:
                print(f"üîä Som reproduzido: {sound_info['name']}")
                return True
            else:
                print(f"‚ö†Ô∏è Todos os canais ocupados para: {sound_info['name']}")
                return False
            
        except Exception as e:
            print(f"‚ùå Erro ao reproduzir som: {e}")
            return False

    def stop_music(self, fade_out_time=0.0):
        """Para m√∫sica de fundo"""
        if not self.initialized or not self.is_music_playing:
            return
        
        try:
            if fade_out_time > 0:
                pygame.mixer.music.fadeout(int(fade_out_time * 1000))
                print(f"üîá M√∫sica parando com fade-out ({fade_out_time}s)")
            else:
                pygame.mixer.music.stop()
                print("üîá M√∫sica parada")
            
            self.is_music_playing = False
            self.current_music_file = None
            
        except Exception as e:
            print(f"‚ùå Erro ao parar m√∫sica: {e}")

    def pause_music(self):
        """Pausa m√∫sica de fundo"""
        if not self.initialized or not self.is_music_playing:
            return
        
        try:
            pygame.mixer.music.pause()
            print("‚è∏Ô∏è M√∫sica pausada")
        except Exception as e:
            print(f"‚ùå Erro ao pausar m√∫sica: {e}")

    def resume_music(self):
        """Resume m√∫sica de fundo"""
        if not self.initialized:
            return
        
        try:
            pygame.mixer.music.unpause()
            print("‚ñ∂Ô∏è M√∫sica resumida")
        except Exception as e:
            print(f"‚ùå Erro ao resumir m√∫sica: {e}")

    def set_music_volume(self, volume):
        """Define volume da m√∫sica (0.0 - 1.0)"""
        self.music_volume = max(0.0, min(1.0, volume))
        if self.initialized and self.is_music_playing:
            pygame.mixer.music.set_volume(self.music_volume * self.master_volume)
        print(f"üéµ Volume da m√∫sica: {self.music_volume:.1f}")

    def set_sfx_volume(self, volume):
        """Define volume dos efeitos sonoros (0.0 - 1.0)"""
        self.sfx_volume = max(0.0, min(1.0, volume))
        print(f"üîä Volume dos efeitos: {self.sfx_volume:.1f}")

    def set_master_volume(self, volume):
        """Define volume geral (0.0 - 1.0)"""
        self.master_volume = max(0.0, min(1.0, volume))
        if self.initialized and self.is_music_playing:
            pygame.mixer.music.set_volume(self.music_volume * self.master_volume)
        print(f"üîä Volume geral: {self.master_volume:.1f}")

    def _get_audio_path(self, file_path):
        if os.path.isabs(file_path):
            return file_path
        
        base_path = os.path.dirname(os.path.dirname(os.path.dirname(__file__)))  # Volta 3 n√≠veis para pasta do projeto
        audio_path = os.path.join(base_path, "audio", file_path)
        
        return audio_path

    def list_loaded_audio(self):
        """Lista todos os √°udios carregados"""
        print("\nüéµ √ÅUDIOS CARREGADOS:")
        
        print(f"üìÄ M√∫sicas ({len(self.loaded_music)}):")
        for name, info in self.loaded_music.items():
            print(f"   üéµ {name}: {info['file_path']}")
        
        print(f"üîä Efeitos ({len(self.loaded_sounds)}):")
        for name, info in self.loaded_sounds.items():
            print(f"   üîä {name}: {info['file_path']}")
        
        print(f"üéõÔ∏è Status:")
        print(f"   üéµ M√∫sica tocando: {self.is_music_playing}")
        print(f"   üéµ M√∫sica atual: {self.current_music_file}")
        print(f"   üîä Volume m√∫sica: {self.music_volume:.1f}")
        print(f"   üîä Volume efeitos: {self.sfx_volume:.1f}")
        print(f"   üîä Volume geral: {self.master_volume:.1f}")

    def cleanup(self):
        """Limpa recursos de √°udio"""
        try:
            if self.is_music_playing:
                pygame.mixer.music.stop()
            
            pygame.mixer.quit()
            print("üßπ AudioManager limpo")
            
        except Exception as e:
            print(f"‚ö†Ô∏è Erro na limpeza do √°udio: {e}")

# üéµ INST√ÇNCIA GLOBAL
audio_manager = AudioManager()